<% for medium in @media %>
	<% unless medium["type"].nil? %>
		<% if medium["type"] == "youtube" %>
			$('#masonry-container').append("<%= j render(:partial => 'videos/show', :locals => {:video => medium, :poll_redis => true}) %>");
		<% elsif medium["type"] == "soundcloud" %>
			$('#masonry-container').append("<%= j render(:partial => 'sounds/show', :locals => {:sound => medium}) %>");
		<% end %>
		$('#masonry-container').masonry('reload');
	<% end %>
<% end %>

<% if @media.next_page %>
  $('.pagination').replaceWith('<%= j will_paginate(@media) %>');
<% else %>
  $('.pagination').remove();
<% end %>

$(document).ajaxComplete(function(){
	$('.poll-redis').each(function(){
		$(this).removeClass('poll-redis');
		var playerId = $(this).attr('id');
	  	var player;
	  	player = new YT.Player(playerId, {
	    	events: {
				'onReady': createYTEvent(playerId),
				'onStateChange': onPlayerStateChange(playerId),
				'onError': onPlayerError
			}
	  	});
	});
	
	function createYTEvent(playerId){ 
		return function (event) {
			var parent_div = $('#'+playerId).parents('.yt_parent');	
			var player = event.target;
			parent_div.addClass('loading');
			player.playVideo();
			player.mute();	
			parent_div.hover(function(){
				$('.selected').trigger('mouseout').removeClass('selected');
				player.seekTo(parent_div.data("start"), 'false');
				player.unMute();	
				player.playVideo();	
			}, function(){
				player.pauseVideo();
			});
		}
	}
	

	function  onPlayerStateChange(playerId){
			return function (event) {
				var parent_div = $('#'+playerId).parents('.yt_parent');	
				var player = event.target
				if (event.data == YT.PlayerState.PLAYING && parent_div.hasClass('loading')){
					player.mute();
					player.pauseVideo();
					parent_div.removeClass('loading');
				}
				else if (event.data == YT.PlayerState.PAUSED){
					parent_div.find('.overlay').fadeOut();	
				}	
		}
	}
	
});